<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <title>SFG Dashboard - Saved Quotations</title>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #f4f7f6; 
            padding: 20px; 
            display: flex; 
            gap: 15px;
        }
        
        .main-content { flex: 1; }

        .summary-sidebar {
            width: 180px; 
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-top: 5px solid #004085;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .sidebar-search {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        .sidebar-search input, .sidebar-search select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 11px;
            box-sizing: border-box;
            outline: none;
            margin-bottom: 10px;
        }

        .summary-sidebar h2 { font-size: 13px; color: #004085; margin: 0 0 15px 0; text-align: center; }
        .summary-item { display: flex; flex-direction: column; align-items: flex-start; padding: 8px 0; border-bottom: 1px solid #f9f9f9; }
        .summary-item:last-child { border-bottom: none; }
        .summary-item h4 { margin: 0; font-size: 10px; color: #666; text-transform: uppercase; }
        .summary-values { text-align: left; font-size: 12px; font-weight: bold; margin-top: 3px; }

        .val-send { color: #007bff; }
        .val-pending { color: #ffc107; }
        .val-completed { color: #28a745; }
        .val-paid { color: #dc3545; }

        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #004085; padding-bottom: 10px; margin-bottom: 20px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .item-wrapper { display: flex; flex-direction: column; }
        
        .quote-card { 
            background: white; border-radius: 6px; border: 1px solid #ccc; 
            padding: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
            transition: border 0.3s ease; position: relative; margin-bottom: 8px; 
        }

        .quote-no-badge {
            position: absolute;
            top: 0;
            left: 0;
            background: #004085;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 5px 0 5px 0;
            z-index: 5;
        }

        .new-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: #dc3545;
            color: white;
            font-size: 9px;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 0 5px 0 5px;
            z-index: 5;
        }

        .border-paid { border: 2px solid #dc3545 !important; }
        .border-completed { border: 2px solid #28a745 !important; }
        .border-pending { border: 2px solid #ffc107 !important; }
        .border-send { border: 2px solid #007bff !important; }

        .quote-card h3 { color: #004085; font-size: 11px; margin: 8px 0 8px 0; line-height: 1.2; border-bottom: 1px solid #eee; padding-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 35px; }
        .card-body-wrapper { display: flex; justify-content: space-between; align-items: center; }
        .info-section { flex: 1; }
        .quote-icon { width: 55px; height: 55px; opacity: 0.7; }
        .quote-card p { font-size: 10px; color: #444; margin: 2px 0; }
        .quote-card .price { font-weight: bold; color: #28a745; font-size: 11px; margin-top: 5px; display: block; }
        .card-footer { margin-top: 10px; display: flex; gap: 4px; }
        .btn-view { background: #004085; color: white; border: none; padding: 5px; cursor: pointer; border-radius: 3px; flex: 1; font-weight: bold; font-size: 10px; }
        .btn-del { background: #dc3545; color: white; border: none; padding: 5px 8px; cursor: pointer; border-radius: 3px; font-size: 10px; }

        .tics-under-box { display: flex; flex-direction: row; justify-content: space-between; padding: 0 2px; }
        .tic-item { display: flex; align-items: center; font-size: 8px; color: #333; font-weight: bold; cursor: pointer; }
        .tic-item input { cursor: pointer; width: 12px; height: 12px; margin-right: 2px; appearance: none; border: 2px solid #ccc; border-radius: 3px; outline: none; transition: 0.2s; }
        
        .check-blue:checked { background-color: #007bff; border-color: #007bff; }
        .check-yellow:checked { background-color: #ffc107; border-color: #ffc107; }
        .check-green:checked { background-color: #28a745; border-color: #28a745; }
        .check-red:checked { background-color: #dc3545; border-color: #dc3545; }
        .tic-item input:checked::before { content: '‚úì'; display: block; text-align: center; color: white; font-size: 9px; line-height: 10px; }

        .btn-back { background: #004085; color: white; text-decoration: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; font-size: 12px; }
        .btn-home { background: #343a40; color: white; text-decoration: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; font-size: 12px; margin-left: 10px; }

        /* Loading Spinner */
        #loading-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.8); display: flex; justify-content: center; 
            align-items: center; z-index: 9999; font-weight: bold; color: #004085;
        }
    </style>
</head>
<body>

<div id="loading-overlay">‚è≥ Loading Data from Cloud...</div>

<div class="main-content">
    <div class="header">
        <h2>SFG Cloud Dashboard</h2>
        <div>
            <button onclick="fetchCloudData()" style="padding: 8px; font-size: 12px; cursor: pointer; background: #28a745; color: white; border: none; border-radius: 4px; margin-right: 10px;">üîÑ Refresh Cloud</button>
            <a href="Sys Files/QUOTATION.html" class="btn-back">+ New Quote</a>
            <a href="index.html" class="btn-home">üè† Home</a>
        </div>
    </div>
    <div class="grid-container" id="dashboard-grid"></div>
</div>

<div class="summary-sidebar">
    <div class="sidebar-search">
        <input type="text" id="searchInput" placeholder="Search RD, Subject..." onkeyup="filterQuotes()">
        <select id="sortSelect" onchange="displayQuotes()">
            <option value="date">Sort by: Date</option>
            <option value="price">Sort by: Price</option>
            <option value="rd">Sort by: RD no</option>
        </select>
    </div>
    <h2>Report</h2>
    <div class="summary-item"><h4>Send</h4><div class="summary-values val-send" id="count-send">0 | 0.00</div></div>
    <div class="summary-item"><h4>Pending</h4><div class="summary-values val-pending" id="count-pending">0 | 0.00</div></div>
    <div class="summary-item"><h4>Completed</h4><div class="summary-values val-completed" id="count-completed">0 | 0.00</div></div>
    <div class="summary-item"><h4>Paid</h4><div class="summary-values val-paid" id="count-paid">0 | 0.00</div></div>
</div>

<script>
    // --- ‡∂∏‡∑ô‡∑Ñ‡∑í ‡∂î‡∂∂‡∂ú‡∑ö Google Script URL ‡∂ë‡∂ö ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyJlNxCcC_Zj3OAg4uHP9VuzqvH9npQs_qHnB1349gjiW-5zO7-lbr9rph1-Ug_yovq1g/exec";

    let cloudQuotes = [];

    // Cloud ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂Ω‡∂∂‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏ (GET Request)
    async function fetchCloudData() {
        document.getElementById('loading-overlay').style.display = 'flex';
        try {
            const response = await fetch(SCRIPT_URL);
            const data = await response.json();
            cloudQuotes = data;
            // Local Storage ‡∂ë‡∂ö‡∂≠‡∑ä Update ‡∂ö‡∂ª‡∂±‡∑Ä‡∑è (offline ‡∑Ä‡∑ê‡∂© ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂±‡∂∏‡∑ä)
            localStorage.setItem('sfg_quotes', JSON.stringify(data));
            displayQuotes();
        } catch (error) {
            console.error("Error fetching data:", error);
            // Cloud ‡∂ë‡∂ö ‡∑Ä‡∑ê‡∂© ‡∂±‡∑ê‡∂≠‡∑ä‡∂±‡∂∏‡∑ä Local Storage ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑Ä‡∑è
            cloudQuotes = JSON.parse(localStorage.getItem('sfg_quotes')) || [];
            displayQuotes();
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    }

    function displayQuotes() {
        const grid = document.getElementById('dashboard-grid');
        const sortVal = document.getElementById('sortSelect').value;
        grid.innerHTML = '';

        // Sorting
        cloudQuotes.sort((a, b) => {
            if (sortVal === 'date') return new Date(b.date) - new Date(a.date);
            if (sortVal === 'price') {
                const pA = parseFloat(String(a.total).replace(/[^0-9.-]+/g,"")) || 0;
                const pB = parseFloat(String(b.total).replace(/[^0-9.-]+/g,"")) || 0;
                return pB - pA;
            }
            if (sortVal === 'rd') return (a.rdNo || "").localeCompare(b.rdNo || "");
            return 0;
        });

        const currentTime = new Date().getTime();

        cloudQuotes.forEach((quote, index) => {
            const displayNo = (index + 1).toString().padStart(2, '0');
            const isNew = (currentTime - Number(quote.id)) / (1000 * 60 * 60) <= 24;

            let borderClass = '';
            if (quote.isPaid) borderClass = 'border-paid';
            else if (quote.isCompleted) borderClass = 'border-completed';
            else if (quote.isPending) borderClass = 'border-pending';
            else if (quote.isSend) borderClass = 'border-send';

            const itemWrapper = document.createElement('div');
            itemWrapper.className = 'item-wrapper';
            itemWrapper.innerHTML = `
                <div class="quote-card ${borderClass}">
                    <span class="quote-no-badge">${displayNo}</span>
                    ${isNew ? '<span class="new-badge">New</span>' : ''}
                    <h3 title="${quote.subject}">${quote.rdNo} - ${quote.subject}</h3>
                    <div class="card-body-wrapper">
                        <div class="info-section">
                            <p>${quote.date}</p>
                            <p>${quote.poNo || 'No PO'}</p>
                            <p>${quote.quoteNo || ''}</p>
                            <span class="price">${quote.total}</span>
                        </div>
                        <img src="Sys Files/image/quoteicon.png" class="quote-icon">
                    </div>
                    <div class="card-footer">
                        <button class="btn-view" onclick="viewQuote(${quote.id})">üëÅÔ∏è View</button>
                        <button class="btn-del" onclick="deleteQuoteById(${quote.id})">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="tics-under-box">
                    <label class="tic-item"><input type="checkbox" class="check-blue" ${quote.isSend ? 'checked' : ''} disabled> Send</label>
                    <label class="tic-item"><input type="checkbox" class="check-yellow" ${quote.isPending ? 'checked' : ''} disabled> Pend</label>
                    <label class="tic-item"><input type="checkbox" class="check-green" ${quote.isCompleted ? 'checked' : ''} disabled> Comp</label>
                    <label class="tic-item"><input type="checkbox" class="check-red" ${quote.isPaid ? 'checked' : ''} disabled> Paid</label>
                </div>
            `;
            grid.appendChild(itemWrapper);
        });
        updateSummary();
    }

    function updateSummary() {
        let stats = { send: 0, pending: 0, completed: 0, paid: 0, sTotal: 0, pTotal: 0, cTotal: 0, paidTotal: 0 };

        cloudQuotes.forEach(q => {
            const price = parseFloat(String(q.total).replace(/[^0-9.-]+/g,"")) || 0;
            if (q.isSend) { stats.send++; stats.sTotal += price; }
            if (q.isPending) { stats.pending++; stats.pTotal += price; }
            if (q.isCompleted) { stats.completed++; stats.cTotal += price; }
            if (q.isPaid) { stats.paid++; stats.paidTotal += price; }
        });

        const fmt = (v) => v.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('count-send').innerText = `${stats.send} | ${fmt(stats.sTotal)}`;
        document.getElementById('count-pending').innerText = `${stats.pending} | ${fmt(stats.pTotal)}`;
        document.getElementById('count-completed').innerText = `${stats.completed} | ${fmt(stats.cTotal)}`;
        document.getElementById('count-paid').innerText = `${stats.paid} | ${fmt(stats.paidTotal)}`;
    }

    function filterQuotes() {
        const input = document.getElementById('searchInput').value.toLowerCase();
        const cards = document.getElementsByClassName('item-wrapper');
        for (let i = 0; i < cards.length; i++) {
            cards[i].style.display = cards[i].innerText.toLowerCase().includes(input) ? "" : "none";
        }
    }

    function viewQuote(id) { window.location.href = `Sys Files/QUOTATION.html?edit=${id}`; }

    // ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂∏‡∑ê‡∂ö‡∑ì‡∂∏ ‡∂Ø‡∑ê‡∂±‡∂ß Local ‡∂¥‡∂∏‡∂´‡∑í, Cloud ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä ‡∂∏‡∑ê‡∂ö‡∑ì‡∂∏‡∂ß Script ‡∂ë‡∂ö‡∑ö Delete function ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂≠‡∑í‡∂∂‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫
    function deleteQuoteById(id) {
        if(confirm("‡∂∏‡∂ö‡∑è ‡∂Ø‡∑ê‡∂∏‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂Ø?")) {
            cloudQuotes = cloudQuotes.filter(q => q.id !== id);
            localStorage.setItem('sfg_quotes', JSON.stringify(cloudQuotes));
            displayQuotes();
        }
    }

    window.onload = fetchCloudData;
</script>
</body>

</html>

